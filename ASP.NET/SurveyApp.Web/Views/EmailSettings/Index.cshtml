
@model SurveyApp.Web.Models.EmailSettingsViewModel

@{
    ViewData["Title"] = "Configuración de Email";
}

<div class="container mt-4">
    <h2>Configuración de Email</h2>
    
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <ul class="nav nav-tabs" id="emailSettingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button" role="tab" aria-controls="smtp" aria-selected="false">SMTP</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="incoming-tab" data-bs-toggle="tab" data-bs-target="#incoming" type="button" role="tab" aria-controls="incoming" aria-selected="false">Correo Entrante</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab" aria-controls="templates" aria-selected="false">Plantillas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab" aria-controls="test" aria-selected="false">Prueba</button>
        </li>
    </ul>
    
    <form asp-action="SaveSettings" method="post" class="mt-3">
        <div class="tab-content" id="emailSettingsTabContent">
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Configuración General</h5>
                        
                        <div class="mb-3">
                            <label asp-for="SenderName" class="form-label">Nombre del Remitente</label>
                            <input asp-for="SenderName" class="form-control" />
                            <span asp-validation-for="SenderName" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="SenderEmail" class="form-label">Email del Remitente</label>
                            <input asp-for="SenderEmail" class="form-control" type="email" />
                            <span asp-validation-for="SenderEmail" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ReplyToEmail" class="form-label">Email de Respuesta (Reply-To)</label>
                            <input asp-for="ReplyToEmail" class="form-control" type="email" />
                            <span asp-validation-for="ReplyToEmail" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="FooterText" class="form-label">Texto del Pie de Página</label>
                            <textarea asp-for="FooterText" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="FooterText" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="TrackEmailOpens" class="form-check-input" type="checkbox" />
                                <label asp-for="TrackEmailOpens" class="form-check-label">Rastrear Aperturas de Email</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="TrackEmailClicks" class="form-check-input" type="checkbox" />
                                <label asp-for="TrackEmailClicks" class="form-check-label">Rastrear Clics en Email</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="smtp" role="tabpanel" aria-labelledby="smtp-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Configuración SMTP</h5>
                        
                        <div class="mb-3">
                            <label asp-for="SmtpServer" class="form-label">Servidor SMTP</label>
                            <input asp-for="SmtpServer" class="form-control" />
                            <span asp-validation-for="SmtpServer" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="SmtpPort" class="form-label">Puerto SMTP</label>
                            <input asp-for="SmtpPort" class="form-control" type="number" />
                            <span asp-validation-for="SmtpPort" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="UseSsl" class="form-check-input" type="checkbox" />
                                <label asp-for="UseSsl" class="form-check-label">Usar SSL</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="RequiresAuthentication" class="form-check-input" type="checkbox" id="requiresAuth" />
                                <label asp-for="RequiresAuthentication" class="form-check-label">Requiere Autenticación</label>
                            </div>
                        </div>
                        
                        <div id="authFields" style="display:none;">
                            <div class="mb-3">
                                <label asp-for="SmtpUsername" class="form-label">Usuario SMTP</label>
                                <input asp-for="SmtpUsername" class="form-control" />
                                <span asp-validation-for="SmtpUsername" class="text-danger"></span>
                            </div>
                            
                            <div class="mb-3">
                                <label asp-for="SmtpPassword" class="form-label">Contraseña SMTP</label>
                                <input asp-for="SmtpPassword" class="form-control" type="password" />
                                <span asp-validation-for="SmtpPassword" class="text-danger"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="EmailsPerBatch" class="form-label">Emails por Lote</label>
                            <input asp-for="EmailsPerBatch" class="form-control" type="number" min="1" />
                            <span asp-validation-for="EmailsPerBatch" class="text-danger"></span>
                            <small class="form-text text-muted">Número máximo de emails enviados en un lote.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="DelayBetweenBatches" class="form-label">Retraso Entre Lotes (segundos)</label>
                            <input asp-for="DelayBetweenBatches" class="form-control" type="number" min="0" />
                            <span asp-validation-for="DelayBetweenBatches" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="incoming" role="tabpanel" aria-labelledby="incoming-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Configuración de Correo Entrante</h5>
                        
                        <div class="mb-3">
                            <label asp-for="IncomingProtocol" class="form-label">Protocolo</label>
                            <select asp-for="IncomingProtocol" class="form-select" id="incomingProtocol">
                                <option value="imap">IMAP</option>
                                <option value="pop3">POP3</option>
                                <option value="none">No configurar</option>
                            </select>
                        </div>
                        
                        <div id="imapFields">
                            <div class="mb-3">
                                <label asp-for="ImapServer" class="form-label">Servidor IMAP</label>
                                <input asp-for="ImapServer" class="form-control" />
                                <span asp-validation-for="ImapServer" class="text-danger"></span>
                            </div>
                            
                            <div class="mb-3">
                                <label asp-for="ImapPort" class="form-label">Puerto IMAP</label>
                                <input asp-for="ImapPort" class="form-control" type="number" value="993" />
                                <span asp-validation-for="ImapPort" class="text-danger"></span>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="UseImapSsl" class="form-check-input" type="checkbox" />
                                    <label asp-for="UseImapSsl" class="form-check-label">Usar SSL</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="popFields" style="display:none;">
                            <div class="mb-3">
                                <label asp-for="PopServer" class="form-label">Servidor POP3</label>
                                <input asp-for="PopServer" class="form-control" />
                                <span asp-validation-for="PopServer" class="text-danger"></span>
                            </div>
                            
                            <div class="mb-3">
                                <label asp-for="PopPort" class="form-label">Puerto POP3</label>
                                <input asp-for="PopPort" class="form-control" type="number" value="995" />
                                <span asp-validation-for="PopPort" class="text-danger"></span>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="UsePopSsl" class="form-check-input" type="checkbox" />
                                    <label asp-for="UsePopSsl" class="form-check-label">Usar SSL</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="AutoCheckEmails" class="form-check-input" type="checkbox" />
                                <label asp-for="AutoCheckEmails" class="form-check-label">Verificar Automáticamente</label>
                            </div>
                            <small class="form-text text-muted">Si está activado, el sistema verificará periódicamente los nuevos correos.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="CheckInterval" class="form-label">Intervalo de Verificación (minutos)</label>
                            <input asp-for="CheckInterval" class="form-control" type="number" min="5" />
                            <span asp-validation-for="CheckInterval" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="templates" role="tabpanel" aria-labelledby="templates-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Plantillas de Email</h5>
                        
                        <div class="mb-3">
                            <label asp-for="SurveyInvitationTemplate" class="form-label">Plantilla de Invitación a Encuesta</label>
                            <textarea asp-for="SurveyInvitationTemplate" class="form-control" rows="10"></textarea>
                            <span asp-validation-for="SurveyInvitationTemplate" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Variables disponibles: {{SurveyTitle}}, {{SurveyDescription}}, {{SurveyLink}}, {{RecipientName}}
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ThankYouTemplate" class="form-label">Plantilla de Agradecimiento</label>
                            <textarea asp-for="ThankYouTemplate" class="form-control" rows="8"></textarea>
                            <span asp-validation-for="ThankYouTemplate" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Variables disponibles: {{RecipientName}}, {{SurveyTitle}}
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="ReminderTemplate" class="form-label">Plantilla de Recordatorio</label>
                            <textarea asp-for="ReminderTemplate" class="form-control" rows="8"></textarea>
                            <span asp-validation-for="ReminderTemplate" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Variables disponibles: {{RecipientName}}, {{SurveyTitle}}, {{SurveyLink}}, {{DaysLeft}}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="test" role="tabpanel" aria-labelledby="test-tab">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Prueba de Configuración</h5>
                        
                        <div class="mb-3">
                            <label for="testEmail" class="form-label">Email de Prueba</label>
                            <input type="email" id="testEmail" class="form-control" />
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" id="testConnectionBtn" class="btn btn-outline-primary">Probar Conexión SMTP</button>
                            <button type="button" id="sendTestEmailBtn" class="btn btn-primary">Enviar Email de Prueba</button>
                        </div>
                        
                        <div id="testResult" class="mt-3" style="display:none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-end mt-3">
            <a asp-action="Index" asp-controller="Home" class="btn btn-outline-secondary me-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Configuración</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Mostrar/ocultar campos de autenticación SMTP
            $('#requiresAuth').change(function() {
                if(this.checked) {
                    $('#authFields').show();
                } else {
                    $('#authFields').hide();
                }
            });
            
            // Inicializar el estado de los campos de autenticación SMTP
            if($('#requiresAuth').is(':checked')) {
                $('#authFields').show();
            }
            
            // Manejar cambio de protocolo entrante
            $('#incomingProtocol').change(function() {
                var value = $(this).val();
                
                if(value === 'imap') {
                    $('#imapFields').show();
                    $('#popFields').hide();
                } 
                else if(value === 'pop3') {
                    $('#imapFields').hide();
                    $('#popFields').show();
                }
                else {
                    $('#imapFields').hide();
                    $('#popFields').hide();
                }
            });
            
            // Inicializar el estado de los campos de protocolo entrante
            $('#incomingProtocol').trigger('change');
            
            // Test connection button
            $('#testConnectionBtn').click(function() {
                var button = $(this);
                button.prop('disabled', true);
                button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Probando...');
                
                $('#testResult').html('').hide();
                
                $.ajax({
                    url: '@Url.Action("TestEmailConnection")',
                    type: 'POST',
                    success: function(result) {
                        button.prop('disabled', false);
                        button.html('Probar Conexión SMTP');
                        
                        if(result.success) {
                            $('#testResult').html('<div class="alert alert-success">Conexión exitosa!</div>').show();
                        } else {
                            $('#testResult').html('<div class="alert alert-danger">Error: ' + result.errorMessage + '</div>').show();
                        }
                    },
                    error: function() {
                        button.prop('disabled', false);
                        button.html('Probar Conexión SMTP');
                        $('#testResult').html('<div class="alert alert-danger">Error en la solicitud</div>').show();
                    }
                });
            });
            
            // Send test email button
            $('#sendTestEmailBtn').click(function() {
                var button = $(this);
                var email = $('#testEmail').val();
                
                if(!email) {
                    $('#testResult').html('<div class="alert alert-warning">Por favor, ingrese un email de prueba</div>').show();
                    return;
                }
                
                button.prop('disabled', true);
                button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...');
                
                $('#testResult').html('').hide();
                
                $.ajax({
                    url: '@Url.Action("SendTestEmail")',
                    type: 'POST',
                    data: { email: email },
                    success: function(result) {
                        button.prop('disabled', false);
                        button.html('Enviar Email de Prueba');
                        
                        if(result.success) {
                            $('#testResult').html('<div class="alert alert-success">Email enviado correctamente!</div>').show();
                        } else {
                            $('#testResult').html('<div class="alert alert-danger">Error: ' + result.errorMessage + '</div>').show();
                        }
                    },
                    error: function() {
                        button.prop('disabled', false);
                        button.html('Enviar Email de Prueba');
                        $('#testResult').html('<div class="alert alert-danger">Error en la solicitud</div>').show();
                    }
                });
            });
        });
    </script>
}
